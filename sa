trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

jobs:
- job: InstallPython
  displayName: 'Install Python'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
      addToPath: true

- job: Build
  displayName: 'Build stage'
  dependsOn: InstallPython
  steps:
  - checkout: self
  - script: |
      sudo apt-get update
      sudo apt-get install python3-venv 
      python -m venv env
      source env/bin/activate
      pip install flask
      pip install pymongo
    displayName: 'Install dependencies'

- job: Test
  displayName: 'Test stage'
  dependsOn: Build
  steps:
    displayName: 'Run tests'

- job: Deploy
  displayName: 'Deploy stage'
  dependsOn: Test
  steps:
  - script: |
      source env/bin/activate
      scp -r ./* Pasupathikumar@20.235.130.103:/home/Pasupathikumar/flask_project_1
      ssh Pasupathikumar@20.235.130.103 "source /home/Pasupathikumar/flask_project_1/env/bin/activate && nohup python /home/Pasupathikumar/flask_project_1/app.py &"
    displayName: 'Deploy to server'
